#!/bin/bash

screensaver_in_focus() {
  hyprctl activewindow -j | jq -e '.class == "org.omarchy.screensaver"' >/dev/null 2>&1
}

exit_screensaver() {
  hyprctl keyword cursor:invisible false
  pkill -x tte 2>/dev/null
  pkill -f org.omarchy.screensaver 2>/dev/null
  exit 0
}

# Exit the screensaver on signals and input from keyboard and mouse
trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT
printf '\e[?1000h\e[?1003h' # Enable mouse tracking (clicks: 1000, movement: 1003)
while read -rsn1 -t 0.1; do :; done # Flush any pending input

printf '\033]11;rgb:00/00/00\007'  # Set background color to black

hyprctl keyword cursor:invisible true &>/dev/null

tty=$(tty 2>/dev/null)

TARGET="2027-01-01 12:00:00"
TARGET_SEC=$(date -d "$TARGET" +%s)


while true; do
  now_sec=$(date +%s)
  diff=$((TARGET_SEC - now_sec))

  if [ "$diff" -le 0 ]; then
    MSG="0:00:00"
  else
    rem=$((diff % 3600))
    hours=$((diff / 3600))
    rem=$((rem % 3600))
    minutes=$((rem / 60))
    seconds=$((rem % 60))
    MSG=$(printf "%02d:%02d" "$hours" "$minutes")
  fi

  echo $MSG | figlet -f poison | tte  \
    --frame-rate 120 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c\
    --random-effect \
    --no-eol --no-restore-cursor \
    &

  while pgrep -t "${tty#/dev/}" -x tte >/dev/null; do
    if read -rsn1 -t 1 || ! screensaver_in_focus; then
      exit_screensaver
    fi
  done
done
